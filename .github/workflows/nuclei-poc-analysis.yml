name: Nuclei POC Daily Analysis

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 09:00 (01:00 UTC) è¿è¡Œ
    - cron: '0 1 * * *'
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
    inputs:
      hours:
        description: 'åˆ†ææœ€è¿‘å¤šå°‘å°æ—¶çš„æ›´æ–° (é»˜è®¤24)'
        required: false
        default: '24'
        type: string

jobs:
  nuclei-analysis:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn install --frozen-lockfile
        
      - name: Run Nuclei POC Analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANALYSIS_HOURS: ${{ github.event.inputs.hours || '24' }}
        run: |
          echo "ğŸ” å¼€å§‹ Nuclei POC åˆ†æ..."
          node scripts/nuclei-poc-analyzer.js
          
      - name: Check for new content
        id: check_content
        run: |
          git add .
          if ! git diff --cached --quiet; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç°æ–°çš„åˆ†æå†…å®¹"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT  
            echo "ğŸ“­ æ²¡æœ‰æ–°çš„åˆ†æå†…å®¹"
          fi
          
      - name: Build site to validate content
        if: steps.check_content.outputs.has_changes == 'true'
        run: |
          echo "ğŸ”¨ æ„å»ºç½‘ç«™éªŒè¯å†…å®¹..."
          yarn build
          
      - name: Commit and push changes
        if: steps.check_content.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # è·å–æ–°å¢çš„æ–‡ä»¶å
          NEW_FILES=$(git diff --cached --name-only --diff-filter=A | grep '\.mdx$' | head -1)
          
          if [ -n "$NEW_FILES" ]; then
            COMMIT_MSG="ğŸ¤– æ–°å¢ Nuclei POC åˆ†ææŠ¥å‘Š - $(date +'%Y-%m-%d')"
          else
            COMMIT_MSG="ğŸ¤– æ›´æ–° Nuclei POC åˆ†æå†…å®¹ - $(date +'%Y-%m-%d')"
          fi
          
          git commit -m "$COMMIT_MSG

ğŸ” Nuclei POC è‡ªåŠ¨åˆ†æç»“æœ
- åˆ†ææ—¶é—´èŒƒå›´: æœ€è¿‘ ${{ github.event.inputs.hours || '24' }} å°æ—¶
- æ•°æ®æ¥æº: ProjectDiscovery/nuclei-templates
- è‡ªåŠ¨åŒ–ç”Ÿæˆï¼ŒåŒ…å«æ¼æ´åˆ†æå’Œå®‰å…¨å»ºè®®

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"
          
          git push
          echo "âœ… å·²æ¨é€æ–°çš„åˆ†ææŠ¥å‘Š"
          
      - name: Create PR for manual review (weekly)
        if: steps.check_content.outputs.has_changes == 'true' && github.event.schedule == '0 1 * * 1'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æ¯å‘¨ä¸€åˆ›å»º PR ç”¨äºäººå·¥å®¡æŸ¥
          BRANCH_NAME="nuclei-analysis-$(date +'%Y-%m-%d')"
          
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
          
          gh pr create \
            --title "ğŸ“Š Nuclei POC å‘¨åº¦åˆ†ææ±‡æ€» - $(date +'%Y-%m-%d')" \
            --body "$(cat <<'EOF'
## ğŸ” Nuclei POC åˆ†ææ±‡æ€»

æœ¬ PR åŒ…å«æœ¬å‘¨çš„ Nuclei POC è‡ªåŠ¨åˆ†æç»“æœã€‚

### ğŸ“‹ å†…å®¹æ¦‚è§ˆ
- ğŸ¤– è‡ªåŠ¨åˆ†ææœ€æ–°çš„ Nuclei æ¨¡æ¿æ›´æ–°
- ğŸ” æ¼æ´å½±å“èŒƒå›´å’Œå±å®³ç¨‹åº¦è¯„ä¼°  
- ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤å»ºè®®å’Œæ‰«ææŒ‡ä»¤
- ğŸ“Š é£é™©ç­‰çº§åˆ†ç±»å’Œç»Ÿè®¡ä¿¡æ¯

### âœ… å®¡æŸ¥è¦ç‚¹
- [ ] æ£€æŸ¥æ¼æ´æè¿°çš„å‡†ç¡®æ€§
- [ ] éªŒè¯é£é™©ç­‰çº§è¯„ä¼°
- [ ] ç¡®è®¤å®‰å…¨å»ºè®®çš„åˆç†æ€§
- [ ] æ£€æŸ¥æ‰«æå‘½ä»¤çš„æ­£ç¡®æ€§

### ğŸ”§ æŠ€æœ¯ç»†èŠ‚
- æ•°æ®æ¥æº: [ProjectDiscovery/nuclei-templates](https://github.com/projectdiscovery/nuclei-templates)
- åˆ†æè„šæœ¬: `scripts/nuclei-poc-analyzer.js`
- ç”Ÿæˆæ—¶é—´: $(date)

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
EOF
)" \
            --head "$BRANCH_NAME" \
            --base main
            
          echo "âœ… å·²åˆ›å»º PR ç”¨äºäººå·¥å®¡æŸ¥"

  # å¥åº·æ£€æŸ¥ä»»åŠ¡
  health-check:
    runs-on: ubuntu-latest
    needs: nuclei-analysis
    if: always()
    
    steps:
      - name: Notify if analysis failed
        if: needs.nuclei-analysis.result == 'failure'
        run: |
          echo "âŒ Nuclei POC åˆ†æå¤±è´¥"
          echo "è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„åŸå› :"
          echo "1. GitHub API é€Ÿç‡é™åˆ¶"
          echo "2. Nuclei æ¨¡æ¿ä»“åº“è®¿é—®é—®é¢˜"  
          echo "3. YAML è§£æé”™è¯¯"
          echo "4. ç½‘ç»œè¿æ¥é—®é¢˜"
          
      - name: Analysis completed successfully
        if: needs.nuclei-analysis.result == 'success'
        run: |
          echo "âœ… Nuclei POC åˆ†æå®Œæˆ"
          echo "ğŸ“Š æ–°çš„å®‰å…¨æƒ…æŠ¥å·²æ·»åŠ åˆ°åšå®¢"