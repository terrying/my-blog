name: Nuclei POC Daily Analysis

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 09:00 (01:00 UTC) è¿è¡Œ
    - cron: '0 1 * * *'
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
    inputs:
      hours:
        description: 'åˆ†æžæœ€è¿‘å¤šå°‘å°æ—¶çš„æ›´æ–° (é»˜è®¤24)'
        required: false
        default: '24'
        type: string

jobs:
  nuclei-analysis:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn install --frozen-lockfile
        
      - name: Run Nuclei POC Analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANALYSIS_HOURS: ${{ github.event.inputs.hours || '24' }}
          MAX_TEMPLATES: 30  # é™åˆ¶æœ€å¤§åˆ†æžæ¨¡æ¿æ•°é‡
        run: |
          echo "ðŸ” å¼€å§‹ Nuclei POC åˆ†æž..."
          echo "ðŸ“Š é…ç½®: åˆ†æžæ—¶é—´=${ANALYSIS_HOURS}å°æ—¶, æœ€å¤§æ¨¡æ¿æ•°=${MAX_TEMPLATES}"
          node scripts/nuclei-poc-analyzer.js
          
      - name: Check for new content
        id: check_content
        run: |
          git add .
          if ! git diff --cached --quiet; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘çŽ°æ–°çš„åˆ†æžå†…å®¹"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT  
            echo "ðŸ“­ æ²¡æœ‰æ–°çš„åˆ†æžå†…å®¹"
          fi
          
      - name: Build site to validate content
        if: steps.check_content.outputs.has_changes == 'true'
        run: |
          echo "ðŸ”¨ æž„å»ºç½‘ç«™éªŒè¯å†…å®¹..."
          yarn build
          
      - name: Commit and push changes
        if: steps.check_content.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # èŽ·å–æ–°å¢žçš„æ–‡ä»¶å
          NEW_FILES=$(git diff --cached --name-only --diff-filter=A | grep '\.mdx$' | head -1)
          
          if [ -n "$NEW_FILES" ]; then
            COMMIT_MSG="ðŸ¤– æ–°å¢ž Nuclei POC åˆ†æžæŠ¥å‘Š - $(date +'%Y-%m-%d')"
          else
            COMMIT_MSG="ðŸ¤– æ›´æ–° Nuclei POC åˆ†æžå†…å®¹ - $(date +'%Y-%m-%d')"
          fi
          
          # åˆ›å»ºå®Œæ•´çš„æäº¤æ¶ˆæ¯
          cat > commit_message.txt << EOF
          $COMMIT_MSG
          
          ðŸ” Nuclei POC è‡ªåŠ¨åˆ†æžç»“æžœ
          - åˆ†æžæ—¶é—´èŒƒå›´: æœ€è¿‘ ${{ github.event.inputs.hours || '24' }} å°æ—¶
          - æ•°æ®æ¥æº: ProjectDiscovery/nuclei-templates
          - è‡ªåŠ¨åŒ–ç”Ÿæˆï¼ŒåŒ…å«æ¼æ´žåˆ†æžå’Œå®‰å…¨å»ºè®®
          
          ðŸ¤– Generated with [Claude Code](https://claude.ai/code)
          
          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          
          git commit -F commit_message.txt
          rm commit_message.txt
          
          git push
          echo "âœ… å·²æŽ¨é€æ–°çš„åˆ†æžæŠ¥å‘Š"
          
      - name: Create PR for manual review (weekly)
        if: steps.check_content.outputs.has_changes == 'true' && github.event.schedule == '0 1 * * 1'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æ¯å‘¨ä¸€åˆ›å»º PR ç”¨äºŽäººå·¥å®¡æŸ¥
          BRANCH_NAME="nuclei-analysis-$(date +'%Y-%m-%d')"
          
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
          
          # åˆ›å»º PR æè¿°æ–‡ä»¶
          cat > pr_body.txt << 'EOF'
          ## ðŸ” Nuclei POC åˆ†æžæ±‡æ€»

          æœ¬ PR åŒ…å«æœ¬å‘¨çš„ Nuclei POC è‡ªåŠ¨åˆ†æžç»“æžœã€‚

          ### ðŸ“‹ å†…å®¹æ¦‚è§ˆ
          - ðŸ¤– è‡ªåŠ¨åˆ†æžæœ€æ–°çš„ Nuclei æ¨¡æ¿æ›´æ–°
          - ðŸ” æ¼æ´žå½±å“èŒƒå›´å’Œå±å®³ç¨‹åº¦è¯„ä¼°  
          - ðŸ›¡ï¸ å®‰å…¨é˜²æŠ¤å»ºè®®å’Œæ‰«ææŒ‡ä»¤
          - ðŸ“Š é£Žé™©ç­‰çº§åˆ†ç±»å’Œç»Ÿè®¡ä¿¡æ¯

          ### âœ… å®¡æŸ¥è¦ç‚¹
          - [ ] æ£€æŸ¥æ¼æ´žæè¿°çš„å‡†ç¡®æ€§
          - [ ] éªŒè¯é£Žé™©ç­‰çº§è¯„ä¼°
          - [ ] ç¡®è®¤å®‰å…¨å»ºè®®çš„åˆç†æ€§
          - [ ] æ£€æŸ¥æ‰«æå‘½ä»¤çš„æ­£ç¡®æ€§

          ### ðŸ”§ æŠ€æœ¯ç»†èŠ‚
          - æ•°æ®æ¥æº: [ProjectDiscovery/nuclei-templates](https://github.com/projectdiscovery/nuclei-templates)
          - åˆ†æžè„šæœ¬: `scripts/nuclei-poc-analyzer.js`

          ðŸ¤– Generated with [Claude Code](https://claude.ai/code)
          EOF
          
          gh pr create \
            --title "ðŸ“Š Nuclei POC å‘¨åº¦åˆ†æžæ±‡æ€» - $(date +'%Y-%m-%d')" \
            --body-file pr_body.txt \
            --head "$BRANCH_NAME" \
            --base main
            
          rm pr_body.txt
          echo "âœ… å·²åˆ›å»º PR ç”¨äºŽäººå·¥å®¡æŸ¥"

  # å¥åº·æ£€æŸ¥ä»»åŠ¡
  health-check:
    runs-on: ubuntu-latest
    needs: nuclei-analysis
    if: always()
    
    steps:
      - name: Notify if analysis failed
        if: needs.nuclei-analysis.result == 'failure'
        run: |
          echo "âŒ Nuclei POC åˆ†æžå¤±è´¥"
          echo "è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„åŽŸå› :"
          echo "1. GitHub API é€ŸçŽ‡é™åˆ¶"
          echo "2. Nuclei æ¨¡æ¿ä»“åº“è®¿é—®é—®é¢˜"  
          echo "3. YAML è§£æžé”™è¯¯"
          echo "4. ç½‘ç»œè¿žæŽ¥é—®é¢˜"
          
      - name: Analysis completed successfully
        if: needs.nuclei-analysis.result == 'success'
        run: |
          echo "âœ… Nuclei POC åˆ†æžå®Œæˆ"
          echo "ðŸ“Š æ–°çš„å®‰å…¨æƒ…æŠ¥å·²æ·»åŠ åˆ°åšå®¢"